name: CI Build and Test

on:
  push:
    branches: [ "main" ]
  # push:
  #   branches: [ "master" ]
  # pull_request:
  #   branches: [ "master" ]

jobs:
  
  build_stage:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-24.04
    steps:
      - name: Check out the repo
        uses: actions/checkout@v6
      
      - name: Log in to Docker Hub 
        uses: docker/login-action@v3
        with: 
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
          
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ranitzahak/test_web_app

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{steps.meta.outputs.tags}}
          labels: ${{steps.meta.outputs.labels}}

  test_stage: 
    needs: [build_stage]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # - name: Download artifact
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: website-artifact
      # - name: Run unit tests
      #   run: npm test

  deploy_satge: #Linux-List-all-files: 
    needs: [build_stage, test_stage]
    runs-on: ubuntu-24.04
    environment: Staging # Environments can be used for protection rules
    steps:
      # - name: Download artifact
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: website-artifact
      # - name: Deploy to Staging
      #   # Example deployment step (replace with actual deployment commands/actions)
      #   run: echo "Deploying artifact to staging server..."

      - name: List all files in the virtual machine (Linux/macOS)
        run:  |
          pwd
          ls  -ltra 
      # - name: deploying
      #   uses: appleboy/ssh-action@v0.1.8
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USER }}
      #     password: ${{ secrets.SSH_KEY }}
      #     port: ${{ secrets.SSH_PORT }}
      #     script: |
      #       docker image pull antonyanlinux/myapp:latest
      #       docker container stop my-container
      #       docker container rm my-container
      #       docker container run -d --name my-container -p 80:5000 antonyanlinux/myapp
  
